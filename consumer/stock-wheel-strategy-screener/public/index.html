<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>WheelAlpha Dashboard</title>
  <style>
    :root {
      --bg: #0d1117; --surface: #161b22; --border: #30363d;
      --text: #e6edf3; --muted: #8b949e; --accent: #58a6ff;
      --green: #3fb950; --red: #f85149; --yellow: #d29922; --purple: #bc8cff;
    }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); min-height: 100vh; }

    /* Header */
    header { background: var(--surface); border-bottom: 1px solid var(--border); padding: 16px 24px; display: flex; align-items: center; justify-content: space-between; }
    header h1 { font-size: 18px; font-weight: 600; }
    header h1 span { color: var(--accent); }
    .header-right { display: flex; align-items: center; gap: 12px; }
    .status-badge { font-size: 12px; padding: 4px 10px; border-radius: 12px; background: var(--border); color: var(--muted); }
    .status-badge.bull { background: rgba(63,185,80,0.15); color: var(--green); }
    .status-badge.bear { background: rgba(248,81,73,0.15); color: var(--red); }
    .status-badge.neutral { background: rgba(210,153,34,0.15); color: var(--yellow); }

    /* Layout */
    .container { max-width: 1280px; margin: 0 auto; padding: 24px; }
    .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px; }
    .grid-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 16px; margin-bottom: 16px; }
    .full { grid-column: 1 / -1; }

    /* Cards */
    .card { background: var(--surface); border: 1px solid var(--border); border-radius: 8px; padding: 20px; }
    .card h2 { font-size: 14px; color: var(--muted); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 12px; }
    .card h3 { font-size: 16px; margin-bottom: 8px; }
    .stat { font-size: 32px; font-weight: 700; }
    .stat.green { color: var(--green); }
    .stat.red { color: var(--red); }
    .stat.blue { color: var(--accent); }

    /* Buttons */
    .btn { padding: 10px 20px; border-radius: 6px; border: none; cursor: pointer; font-size: 14px; font-weight: 500; transition: all 0.15s; }
    .btn-primary { background: var(--accent); color: #fff; }
    .btn-primary:hover { background: #4c94e6; }
    .btn-primary:disabled { opacity: 0.5; cursor: not-allowed; }
    .btn-outline { background: transparent; color: var(--accent); border: 1px solid var(--border); }
    .btn-outline:hover { background: rgba(88,166,255,0.1); }

    /* Table */
    table { width: 100%; border-collapse: collapse; font-size: 13px; }
    th { text-align: left; padding: 10px 12px; color: var(--muted); border-bottom: 1px solid var(--border); font-weight: 500; }
    td { padding: 10px 12px; border-bottom: 1px solid var(--border); }
    tr:hover td { background: rgba(88,166,255,0.04); }

    /* Tags */
    .tag { display: inline-block; font-size: 11px; padding: 2px 8px; border-radius: 10px; margin-right: 4px; }
    .tag-csp { background: rgba(88,166,255,0.15); color: var(--accent); }
    .tag-cc { background: rgba(188,140,255,0.15); color: var(--purple); }
    .tag-value { background: rgba(63,185,80,0.15); color: var(--green); }
    .tag-etf { background: rgba(210,153,34,0.15); color: var(--yellow); }
    .tag-flag { background: rgba(248,81,73,0.15); color: var(--red); }

    /* Tabs */
    .tabs { display: flex; gap: 0; margin-bottom: 16px; border-bottom: 1px solid var(--border); }
    .tab { padding: 10px 20px; cursor: pointer; color: var(--muted); border-bottom: 2px solid transparent; font-size: 14px; transition: all 0.15s; }
    .tab:hover { color: var(--text); }
    .tab.active { color: var(--accent); border-bottom-color: var(--accent); }
    .tab-content { display: none; }
    .tab-content.active { display: block; }

    /* Feedback */
    .feedback-area { width: 100%; min-height: 120px; background: var(--bg); color: var(--text); border: 1px solid var(--border); border-radius: 6px; padding: 12px; font-family: 'SF Mono', 'Fira Code', monospace; font-size: 13px; resize: vertical; }
    .feedback-area::placeholder { color: var(--muted); }
    .feedback-actions { display: flex; gap: 8px; margin-top: 12px; align-items: center; }
    .feedback-result { margin-top: 12px; padding: 12px; background: var(--bg); border-radius: 6px; font-family: monospace; font-size: 12px; max-height: 200px; overflow-y: auto; }

    /* Pipeline log */
    .log { background: var(--bg); border-radius: 6px; padding: 16px; font-family: 'SF Mono', monospace; font-size: 13px; line-height: 1.8; max-height: 300px; overflow-y: auto; white-space: pre-wrap; }
    .log .step { color: var(--muted); }
    .log .ok { color: var(--green); }
    .log .info { color: var(--accent); }

    /* Email preview */
    .email-preview { background: var(--bg); padding: 20px; border-radius: 6px; font-size: 13px; line-height: 1.7; max-height: 600px; overflow-y: auto; white-space: pre-wrap; }

    /* Empty state */
    .empty { text-align: center; padding: 60px 20px; color: var(--muted); }
    .empty h3 { font-size: 18px; margin-bottom: 8px; color: var(--text); }
    .empty p { margin-bottom: 20px; }

    /* Blocked detail */
    .blocked-item { padding: 10px 12px; border-bottom: 1px solid var(--border); }
    .blocked-item:last-child { border-bottom: none; }
    .blocked-reason { color: var(--red); font-size: 12px; margin-top: 4px; }

    /* Quick commands */
    .quick-cmds { display: flex; flex-wrap: wrap; gap: 6px; margin-bottom: 12px; }
    .quick-cmd { font-size: 11px; padding: 4px 10px; border-radius: 4px; background: var(--bg); border: 1px solid var(--border); color: var(--muted); cursor: pointer; }
    /* Toggle switch */
    .toggle-wrap { display: flex; align-items: center; gap: 8px; font-size: 13px; }
    .toggle-label { color: var(--muted); }
    .toggle-label.active { color: var(--green); font-weight: 600; }
    .toggle { position: relative; width: 44px; height: 24px; cursor: pointer; }
    .toggle input { opacity: 0; width: 0; height: 0; }
    .toggle .slider { position: absolute; inset: 0; background: var(--border); border-radius: 12px; transition: 0.2s; }
    .toggle .slider::before { content: ''; position: absolute; width: 18px; height: 18px; left: 3px; bottom: 3px; background: var(--text); border-radius: 50%; transition: 0.2s; }
    .toggle input:checked + .slider { background: var(--green); }
    .toggle input:checked + .slider::before { transform: translateX(20px); }
    .quick-cmd:hover { color: var(--accent); border-color: var(--accent); }
  </style>
</head>
<body>
  <header>
    <h1>üìä <span>WheelAlpha</span> Dashboard</h1>
    <div class="header-right">
      <div class="toggle-wrap">
        <span class="toggle-label" id="label-mock">Mock</span>
        <label class="toggle">
          <input type="checkbox" id="live-toggle" onchange="updateModeLabel()">
          <span class="slider"></span>
        </label>
        <span class="toggle-label" id="label-live">Live</span>
      </div>
      <span class="status-badge" id="regime-badge">No data</span>
      <button class="btn btn-primary" id="run-btn" onclick="runPipeline()">‚ñ∂ Run Pipeline</button>
    </div>
  </header>

  <div class="container">
    <!-- Empty state -->
    <div id="empty-state" class="empty">
      <h3>Welcome to WheelAlpha</h3>
      <p>Run the daily pipeline to generate investment insights and draft orders.</p>
      <button class="btn btn-primary" onclick="runPipeline()">‚ñ∂ Run Daily Pipeline</button>
    </div>

    <!-- Dashboard content (hidden until first run) -->
    <div id="dashboard" style="display:none">
      <!-- Stats row -->
      <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:16px;margin-bottom:16px" id="stats-row">
        <div class="card">
          <h2>Stocks Scanned</h2>
          <div class="stat blue" id="stat-scanned">0</div>
        </div>
        <div class="card">
          <h2>Approved</h2>
          <div class="stat green" id="stat-approved">0</div>
        </div>
        <div class="card">
          <h2>Blocked</h2>
          <div class="stat red" id="stat-blocked">0</div>
        </div>
        <div class="card">
          <h2>Draft Orders</h2>
          <div class="stat blue" id="stat-drafts">0</div>
        </div>
      </div>

      <!-- Market regime note -->
      <div class="card" style="margin-bottom:16px;padding:14px 20px">
        <div style="display:flex;align-items:center;gap:12px">
          <span style="font-size:20px" id="regime-icon">üìä</span>
          <div>
            <strong id="regime-title">‚Äî</strong>
            <div style="color:var(--muted);font-size:13px;margin-top:2px" id="regime-notes">Run the pipeline to see market regime</div>
          </div>
        </div>
      </div>

      <!-- Tabs -->
      <div class="tabs">
        <div class="tab active" data-tab="opportunities" onclick="switchTab(this)">üèÜ Top Returns</div>
        <div class="tab" data-tab="fundamentals" onclick="switchTab(this)">üî¨ Fundamentals</div>
        <div class="tab" data-tab="csp" onclick="switchTab(this)">üí∞ CSP</div>
        <div class="tab" data-tab="value" onclick="switchTab(this)">üè¶ Value</div>
        <div class="tab" data-tab="etf" onclick="switchTab(this)">üåê ETF</div>
        <div class="tab" data-tab="drafts" onclick="switchTab(this)">Draft Orders</div>
        <div class="tab" data-tab="blocked" onclick="switchTab(this)">Blocked</div>
        <div class="tab" data-tab="email" onclick="switchTab(this)">Email</div>
        <div class="tab" data-tab="feedback" onclick="switchTab(this)">Feedback</div>
        <div class="tab" data-tab="log" onclick="switchTab(this)">Log</div>
      </div>

      <!-- Top Returns (all categories sorted by score) -->
      <div class="tab-content active" id="tab-opportunities">
        <div class="card">
          <h2 style="margin-bottom:8px">üèÜ Top Opportunities by Return ‚Äî All Categories</h2>
          <table>
            <thead><tr><th>#</th><th>Category</th><th>Symbol</th><th>Price</th><th>Score</th><th>Key Metric</th><th>Action</th><th>Flags</th></tr></thead>
            <tbody id="opp-table"></tbody>
          </table>
        </div>
      </div>

      <!-- Fundamentals -->
      <div class="tab-content" id="tab-fundamentals">
        <div class="card">
          <h2 style="margin-bottom:4px">üî¨ Fundamental Quality Scores ‚Äî S&P 500</h2>
          <p style="color:var(--muted);font-size:12px;margin-bottom:8px">Composite quality score from profitability, growth, valuation, balance sheet &amp; dividend. Grades: A (‚â•85) B (‚â•70) C (‚â•55) D (‚â•40) F (&lt;40)</p>
          <div style="display:flex;gap:8px;margin-bottom:12px;flex-wrap:wrap" id="fund-grade-summary"></div>
          <div style="overflow-x:auto">
          <table>
            <thead><tr>
              <th>#</th><th>Grade</th><th>Symbol</th><th>Sector</th><th>Quality</th>
              <th>Profit.</th><th>Growth</th><th>Valuat.</th><th>Balance</th><th>Divid.</th>
              <th>ROE</th><th>Margin</th><th>Rev Gr.</th><th>P/E</th><th>Fwd P/E</th><th>D/E</th><th>Yield</th><th>Analyst</th>
            </tr></thead>
            <tbody id="fund-table"></tbody>
          </table>
          </div>
        </div>
      </div>

      <!-- CSP Opportunities -->
      <div class="tab-content" id="tab-csp">
        <div class="card">
          <h2 style="margin-bottom:8px">üí∞ Cash-Secured Put Opportunities</h2>
          <p style="color:var(--muted);font-size:12px;margin-bottom:12px">Sorted by annualized yield. Filtered by DTE, delta, premium, and earnings blackout.</p>
          <table>
            <thead><tr><th>#</th><th>Symbol</th><th>Price</th><th>Strike</th><th>Expiry</th><th>DTE</th><th>Delta</th><th>Premium</th><th>Ann. Yield</th><th>Collateral</th><th>Eff. Cost</th><th>Quality</th><th>Score</th><th>Flags</th></tr></thead>
            <tbody id="csp-table"></tbody>
          </table>
        </div>
      </div>

      <!-- Value Opportunities -->
      <div class="tab-content" id="tab-value">
        <div class="card">
          <h2 style="margin-bottom:8px">üè¶ Long-Term Value Picks</h2>
          <p style="color:var(--muted);font-size:12px;margin-bottom:12px">Fundamentals screen: ROIC, revenue CAGR, FCF, P/E valuation discount.</p>
          <table>
            <thead><tr><th>#</th><th>Symbol</th><th>Price</th><th>Mkt Cap</th><th>P/E</th><th>5yr Avg P/E</th><th>Discount</th><th>ROIC</th><th>Rev CAGR</th><th>Score</th><th>Action</th><th>Flags</th></tr></thead>
            <tbody id="value-table"></tbody>
          </table>
        </div>
      </div>

      <!-- ETF Opportunities -->
      <div class="tab-content" id="tab-etf">
        <div class="card">
          <h2 style="margin-bottom:8px">üåê ETF Allocation & Rebalancing</h2>
          <p style="color:var(--muted);font-size:12px;margin-bottom:12px">Drift detection vs target allocation. Includes rebalance suggestions.</p>
          <table>
            <thead><tr><th>#</th><th>Symbol</th><th>Price</th><th>Name / Detail</th><th>YTD</th><th>Yield</th><th>Score</th><th>Action</th><th>Flags</th></tr></thead>
            <tbody id="etf-table"></tbody>
          </table>
        </div>
      </div>

      <!-- Draft Orders -->
      <div class="tab-content" id="tab-drafts">
        <div class="card">
          <table>
            <thead><tr><th>Order ID</th><th>Type</th><th>Symbol</th><th>Qty</th><th>Details</th><th>Price</th><th>Action</th></tr></thead>
            <tbody id="drafts-table"></tbody>
          </table>
        </div>
      </div>

      <!-- Blocked -->
      <div class="tab-content" id="tab-blocked">
        <div class="card">
          <div id="blocked-list"></div>
        </div>
      </div>

      <!-- Email Preview -->
      <div class="tab-content" id="tab-email">
        <div class="card">
          <div class="email-preview" id="email-content"></div>
        </div>
      </div>

      <!-- Feedback -->
      <div class="tab-content" id="tab-feedback">
        <div class="card">
          <h2>Send Feedback Commands</h2>
          <div class="quick-cmds" id="quick-commands"></div>
          <textarea class="feedback-area" id="feedback-input" placeholder="APPROVE: ord-csp-abc123&#10;REJECT: ord-cc-def456&#10;SET_RULE: wheel.csp_delta_range=[0.18,0.25]&#10;NOTE: Prefer lower delta this week"></textarea>
          <div class="feedback-actions">
            <button class="btn btn-primary" onclick="submitFeedback()">Submit Feedback</button>
            <button class="btn btn-outline" onclick="document.getElementById('feedback-input').value=''">Clear</button>
          </div>
          <div class="feedback-result" id="feedback-result" style="display:none"></div>
        </div>
      </div>

      <!-- Pipeline Log -->
      <div class="tab-content" id="tab-log">
        <div class="card">
          <div class="log" id="pipeline-log">Pipeline has not been run yet.</div>
        </div>
      </div>
    </div>
  </div>

  <script>
    let currentReport = null;

    function getMode() {
      return document.getElementById('live-toggle').checked ? 'live' : 'mock';
    }

    function updateModeLabel() {
      const isLive = document.getElementById('live-toggle').checked;
      document.getElementById('label-mock').className = 'toggle-label' + (isLive ? '' : ' active');
      document.getElementById('label-live').className = 'toggle-label' + (isLive ? ' active' : '');
    }

    async function runPipeline() {
      const btn = document.getElementById('run-btn');
      const mode = getMode();
      btn.disabled = true;
      btn.textContent = mode === 'live' ? 'üî¥ Fetching live data...' : '‚è≥ Running...';

      document.getElementById('empty-state').style.display = 'none';
      document.getElementById('dashboard').style.display = 'block';

      // Switch to log tab
      document.querySelector('[data-tab="log"]').click();
      const log = document.getElementById('pipeline-log');
      log.innerHTML = '<span class="info">üöÄ Starting daily pipeline...</span>\n';

      try {
        const res = await fetch('/api/run', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ mode }),
        });
        const data = await res.json();

        if (!res.ok) throw new Error(data.error);

        currentReport = data.report;

        // Update log
        const r = data.report;
        log.innerHTML = `<span class="info">üöÄ WheelAlpha Daily Pipeline ‚Äî ${r.date}</span>
<span class="step">üìä [1/8] Market Regime Agent...</span>  <span class="ok">‚Üí ${r.market_regime.regime} (${r.market_regime.risk_posture})</span>
<span class="step">üî¨ [1.5/8] Fundamentals Agent...</span> <span class="ok">‚Üí ${(r.fundamental_profiles||[]).length} stock profiles scored</span>
<span class="step">üí∞ [2/8] Wheel CSP Agent...</span>      <span class="ok">‚Üí ${r.approved_opportunities.filter(o=>o.category==='CSP').length + r.blocked_opportunities.filter(o=>o.opportunity.category==='CSP').length} opportunities</span>
<span class="step">üìà [3/8] Covered Call Agent...</span>   <span class="ok">‚Üí ${r.approved_opportunities.filter(o=>o.category==='CC').length + r.blocked_opportunities.filter(o=>o.opportunity.category==='CC').length} opportunities</span>
<span class="step">üè¶ [4/8] Value Agent...</span>          <span class="ok">‚Üí ${r.approved_opportunities.filter(o=>o.category==='VALUE').length} value picks</span>
<span class="step">üåê [5/8] ETF Agent...</span>            <span class="ok">‚Üí ${r.approved_opportunities.filter(o=>o.category==='ETF').length + r.blocked_opportunities.filter(o=>o.opportunity.category==='ETF').length} ETF insights</span>
<span class="step">üõ°Ô∏è  [6/8] Risk Gatekeeper...</span>     <span class="ok">‚Üí ${r.approved_opportunities.length} approved, ${r.blocked_opportunities.length} blocked</span>
<span class="step">üìß [8/8] Report/Email Agent...</span>   <span class="ok">‚Üí email generated</span>

<span class="ok">‚úÖ Pipeline complete ‚Äî ${r.order_drafts.length} draft orders ready for review</span>`;

        renderDashboard(data);

        // Switch to opportunities tab
        document.querySelector('[data-tab="opportunities"]').click();
      } catch (err) {
        log.innerHTML += `\n<span style="color:var(--red)">‚ùå Error: ${err.message}</span>`;
      } finally {
        btn.disabled = false;
        btn.textContent = '‚ñ∂ Run Pipeline';
      }
    }

    function renderDashboard(data) {
      const r = data.report;

      // Regime badge + notes
      const badge = document.getElementById('regime-badge');
      badge.textContent = `${r.market_regime.regime} ‚Äî ${r.market_regime.risk_posture}`;
      badge.className = `status-badge ${r.market_regime.regime.toLowerCase()}`;
      document.getElementById('regime-title').textContent = `${r.market_regime.regime} Market ‚Äî ${r.market_regime.risk_posture}`;
      document.getElementById('regime-notes').textContent = r.market_regime.notes;
      document.getElementById('regime-icon').textContent = r.market_regime.regime === 'Bull' ? 'üü¢' : r.market_regime.regime === 'Bear' ? 'üî¥' : 'üü°';

      // Stats
      const allUnique = new Set([
        ...r.approved_opportunities.map(o => o.symbol),
        ...r.blocked_opportunities.map(b => b.opportunity.symbol),
      ]);
      document.getElementById('stat-scanned').textContent = allUnique.size;
      document.getElementById('stat-approved').textContent = r.approved_opportunities.length;
      document.getElementById('stat-blocked').textContent = r.blocked_opportunities.length;
      document.getElementById('stat-drafts').textContent = r.order_drafts.length;

      // Only approved opportunities in main tabs; blocked shown only in Blocked tab
      const allOpps = r.approved_opportunities
        .map(o => ({...o, status: 'approved'}))
        .sort((a, b) => b.score - a.score);

      // ‚îÄ‚îÄ Top Returns tab (all categories, ranked) ‚îÄ‚îÄ
      const oppBody = document.getElementById('opp-table');
      oppBody.innerHTML = allOpps.slice(0, 30).map((o, i) => {
        const d = o.details || {};
        let keyMetric = '';
        let action = d.action || '';
        let price = d.current_price ? '$' + d.current_price.toFixed(2) : '';
        if (o.category === 'CSP') {
          keyMetric = d.annualized_yield ? d.annualized_yield + '% ann.' : '';
          action = 'SELL PUT $' + (d.strike||'') + ' @ $' + (d.premium ? d.premium.toFixed(2) : '?');
        } else if (o.category === 'CC') {
          keyMetric = d.if_called_return_pct ? d.if_called_return_pct + '% if called' : '';
        } else if (o.category === 'VALUE') {
          keyMetric = d.valuation_discount ? d.valuation_discount + '% discount' : '';
          action = 'BUY @ ~$' + (d.current_price ? d.current_price.toFixed(2) : '?');
        } else if (o.category === 'ETF') {
          keyMetric = d.drift_pct ? Math.abs(d.drift_pct) + '% drift' : (d.ytd_return ? d.ytd_return + '% YTD' : '');
          action = d.current_price ? 'BUY @ ~$' + d.current_price.toFixed(2) : '';
        }
        return `
          <tr>
            <td>${i+1}</td>
            <td><span class="tag tag-${o.category.toLowerCase()}">${o.category}</span></td>
            <td><strong>${o.symbol}</strong></td>
            <td>${price}</td>
            <td>${o.score}</td>
            <td><strong>${keyMetric}</strong></td>
            <td style="font-size:11px;font-family:monospace;color:var(--accent)">${action}</td>
            <td>${o.risk_flags.map(f => '<span class="tag tag-flag">'+f+'</span>').join('') || '‚Äî'}</td>
          </tr>`;
      }).join('');

      // ‚îÄ‚îÄ CSP tab ‚îÄ‚îÄ
      const cspOpps = allOpps.filter(o => o.category === 'CSP');
      const cspBody = document.getElementById('csp-table');
      cspBody.innerHTML = cspOpps.map((o, i) => {
        const d = o.details || {};
        const qs = d.quality_score || 0;
        const qColor = qs >= 70 ? '#3fb950' : qs >= 50 ? '#d29922' : '#f85149';
        return `
          <tr>
            <td>${i+1}</td>
            <td><strong>${o.symbol}</strong></td>
            <td>${d.current_price ? '$'+d.current_price.toFixed(2) : '‚Äî'}</td>
            <td>$${d.strike || '‚Äî'}</td>
            <td>${d.expiry || '‚Äî'}</td>
            <td>${d.dte || '‚Äî'}d</td>
            <td>${d.delta ? d.delta.toFixed(2) : '‚Äî'}</td>
            <td>$${d.premium ? d.premium.toFixed(2) : '‚Äî'}</td>
            <td><strong>${d.annualized_yield || '‚Äî'}%</strong></td>
            <td style="font-size:11px">$${d.collateral ? d.collateral.toLocaleString() : '‚Äî'}</td>
            <td style="font-size:11px;color:var(--green)">$${d.effective_cost_basis || '‚Äî'}</td>
            <td><span style="color:${qColor};font-weight:600">${qs}</span></td>
            <td>${o.score}</td>
            <td>${o.risk_flags.map(f => '<span class="tag tag-flag">'+f+'</span>').join('') || '‚Äî'}</td>
          </tr>`;
      }).join('') || '<tr><td colspan="14" style="text-align:center;color:var(--muted);padding:30px">No CSP opportunities in current run</td></tr>';

      // ‚îÄ‚îÄ Value tab ‚îÄ‚îÄ
      const valOpps = allOpps.filter(o => o.category === 'VALUE');
      const valBody = document.getElementById('value-table');
      valBody.innerHTML = valOpps.map((o, i) => {
        const d = o.details || {};
        return `
          <tr>
            <td>${i+1}</td>
            <td><strong>${o.symbol}</strong></td>
            <td style="color:var(--accent)">${d.current_price ? '$'+d.current_price.toFixed(2) : '‚Äî'}</td>
            <td style="font-size:11px">${d.market_cap_b ? '$'+d.market_cap_b+'B' : '‚Äî'}</td>
            <td>${d.pe_ratio || '‚Äî'}</td>
            <td>${d.pe_5y_avg ? (+d.pe_5y_avg).toFixed(1) : '‚Äî'}</td>
            <td><strong>${d.valuation_discount || '‚Äî'}%</strong></td>
            <td>${d.roic || '‚Äî'}%</td>
            <td>${d.rev_cagr_5y || '‚Äî'}%</td>
            <td>${o.score}</td>
            <td style="font-size:11px;font-family:monospace;color:var(--accent)">${d.action || 'BUY shares'}</td>
            <td>${o.risk_flags.map(f => '<span class="tag tag-flag">'+f+'</span>').join('') || '‚Äî'}</td>
          </tr>`;
      }).join('') || '<tr><td colspan="12" style="text-align:center;color:var(--muted);padding:30px">No value opportunities ‚Äî filters may be too strict</td></tr>';

      // ‚îÄ‚îÄ ETF tab ‚îÄ‚îÄ
      const etfOpps = allOpps.filter(o => o.category === 'ETF');
      const etfBody = document.getElementById('etf-table');
      etfBody.innerHTML = etfOpps.map((o, i) => {
        const d = o.details || {};
        return `
          <tr>
            <td>${i+1}</td>
            <td><strong>${o.symbol}</strong></td>
            <td style="color:var(--accent)">${d.current_price ? '$'+d.current_price.toFixed(2) : '‚Äî'}</td>
            <td style="font-size:12px">${o.rationale.split('.')[0]}</td>
            <td>${d.ytd_return ? d.ytd_return+'%' : '‚Äî'}</td>
            <td>${d.div_yield ? d.div_yield+'%' : '‚Äî'}</td>
            <td>${o.score}</td>
            <td style="font-size:11px;font-family:monospace;color:var(--accent)">${d.action || '‚Äî'}</td>
            <td>${o.risk_flags.map(f => '<span class="tag tag-flag">'+f+'</span>').join('') || '‚Äî'}</td>
          </tr>`;
      }).join('') || '<tr><td colspan="9" style="text-align:center;color:var(--muted);padding:30px">No ETF insights</td></tr>';

      // ‚îÄ‚îÄ Fundamentals tab ‚îÄ‚îÄ
      const profiles = r.fundamental_profiles || [];
      const gradeColors = { A: '#3fb950', B: '#58a6ff', C: '#d29922', D: '#f0883e', F: '#f85149' };
      const gradeCounts = {};
      profiles.forEach(p => { gradeCounts[p.grade] = (gradeCounts[p.grade] || 0) + 1; });
      const gradeSummaryEl = document.getElementById('fund-grade-summary');
      gradeSummaryEl.innerHTML = ['A','B','C','D','F'].filter(g => gradeCounts[g]).map(g =>
        '<span style="background:' + gradeColors[g] + '22;color:' + gradeColors[g] + ';padding:4px 10px;border-radius:12px;font-size:12px;font-weight:600">' + g + ': ' + gradeCounts[g] + '</span>'
      ).join('');

      const fundBody = document.getElementById('fund-table');
      fundBody.innerHTML = profiles.map((p, i) => {
        const gc = gradeColors[p.grade] || '#8b949e';
        const scoreBar = (val, max) => {
          const pct = Math.min(100, (val / max) * 100);
          const color = pct >= 70 ? '#3fb950' : pct >= 50 ? '#d29922' : '#f85149';
          return '<div style="width:60px;height:6px;background:#30363d;border-radius:3px;display:inline-block;vertical-align:middle;margin-left:4px"><div style="width:' + pct + '%;height:100%;background:' + color + ';border-radius:3px"></div></div>';
        };
        const ratingEmoji = p.analyst_rating === 'buy' || p.analyst_rating === 'strongBuy' ? 'üü¢' : p.analyst_rating === 'hold' ? 'üü°' : p.analyst_rating === 'sell' ? 'üî¥' : '‚ö™';
        return '<tr>' +
          '<td>' + (i+1) + '</td>' +
          '<td><span style="background:' + gc + '22;color:' + gc + ';padding:2px 8px;border-radius:8px;font-weight:700;font-size:13px">' + p.grade + '</span></td>' +
          '<td><strong>' + p.symbol + '</strong></td>' +
          '<td style="font-size:11px;color:var(--muted)">' + p.sector + '</td>' +
          '<td><strong>' + p.quality_score + '</strong>' + scoreBar(p.quality_score, 100) + '</td>' +
          '<td>' + p.profitability_score + scoreBar(p.profitability_score, 100) + '</td>' +
          '<td>' + p.growth_score + scoreBar(p.growth_score, 100) + '</td>' +
          '<td>' + p.valuation_score + scoreBar(p.valuation_score, 100) + '</td>' +
          '<td>' + p.balance_sheet_score + scoreBar(p.balance_sheet_score, 100) + '</td>' +
          '<td>' + p.dividend_score + scoreBar(p.dividend_score, 100) + '</td>' +
          '<td>' + p.roe + '%</td>' +
          '<td>' + p.profit_margin + '%</td>' +
          '<td>' + p.revenue_growth + '%</td>' +
          '<td>' + p.pe_ratio + '</td>' +
          '<td>' + p.forward_pe + '</td>' +
          '<td>' + p.debt_to_equity + '</td>' +
          '<td>' + p.dividend_yield + '%</td>' +
          '<td>' + ratingEmoji + ' ' + p.analyst_rating + (p.analyst_upside > 0 ? ' (+' + p.analyst_upside + '%)' : '') + '</td>' +
          '</tr>';
      }).join('') || '<tr><td colspan="18" style="text-align:center;color:var(--muted);padding:30px">No fundamental data ‚Äî run pipeline first</td></tr>';

      // Draft orders
      const draftsBody = document.getElementById('drafts-table');
      draftsBody.innerHTML = r.order_drafts.map(d => {
        const details = d.option ? `${d.option.put_call} $${d.option.strike} exp ${d.option.expiry}` : 'shares';
        const price = d.limit_price ? `$${d.limit_price}` : 'MKT';
        return `
          <tr>
            <td><code>${d.order_id}</code></td>
            <td><span class="tag tag-${d.type.toLowerCase()}">${d.type}</span></td>
            <td><strong>${d.symbol}</strong></td>
            <td>${d.quantity}</td>
            <td>${details}</td>
            <td>${price}</td>
            <td>
              <button class="btn btn-outline" style="padding:4px 8px;font-size:11px" onclick="quickApprove('${d.order_id}')">‚úì Approve</button>
              <button class="btn btn-outline" style="padding:4px 8px;font-size:11px;margin-left:4px" onclick="quickReject('${d.order_id}')">‚úó Reject</button>
            </td>
          </tr>`;
      }).join('');

      // Blocked list
      const blockedList = document.getElementById('blocked-list');
      if (r.blocked_opportunities.length === 0) {
        blockedList.innerHTML = '<p style="color:var(--muted);padding:20px;text-align:center">No blocked opportunities</p>';
      } else {
        blockedList.innerHTML = r.blocked_opportunities.map(b => `
          <div class="blocked-item">
            <span class="tag tag-${b.opportunity.category.toLowerCase()}">${b.opportunity.category}</span>
            <strong>${b.opportunity.symbol}</strong> (score: ${b.opportunity.score})
            <div class="blocked-reason">üö´ ${b.reason}</div>
          </div>`).join('');
      }

      // Email preview
      document.getElementById('email-content').textContent = data.email;

      // Quick commands for feedback
      const quickCmds = document.getElementById('quick-commands');
      quickCmds.innerHTML = r.order_drafts.map(d =>
        `<span class="quick-cmd" onclick="appendCmd('APPROVE: ${d.order_id}')">‚úì ${d.order_id}</span>`
      ).join('') +
      `<span class="quick-cmd" onclick="appendCmd('SET_RULE: wheel.csp_delta_range=[0.18,0.25]')">Tighten CSP delta</span>` +
      `<span class="quick-cmd" onclick="appendCmd('ADD_TO_LIST: watchlists.wheel_universe+=TSM')">Add TSM</span>` +
      `<span class="quick-cmd" onclick="appendCmd('NOTE: ')">Add note</span>`;
    }

    function appendCmd(cmd) {
      const ta = document.getElementById('feedback-input');
      ta.value = ta.value ? ta.value + '\n' + cmd : cmd;
      ta.focus();
    }

    function quickApprove(id) { appendCmd(`APPROVE: ${id}`); document.querySelector('[data-tab="feedback"]').click(); }
    function quickReject(id) { appendCmd(`REJECT: ${id}`); document.querySelector('[data-tab="feedback"]').click(); }

    async function submitFeedback() {
      const text = document.getElementById('feedback-input').value.trim();
      if (!text) return;
      const resultEl = document.getElementById('feedback-result');
      try {
        const res = await fetch('/api/feedback', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ text }),
        });
        const data = await res.json();
        resultEl.style.display = 'block';
        resultEl.innerHTML = `<span style="color:var(--green)">‚úÖ Feedback parsed: ${data.feedback.actions.length} action(s)</span>\n\n${JSON.stringify(data.feedback, null, 2)}`;
      } catch (err) {
        resultEl.style.display = 'block';
        resultEl.innerHTML = `<span style="color:var(--red)">‚ùå ${err.message}</span>`;
      }
    }

    function switchTab(el) {
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
      el.classList.add('active');
      document.getElementById('tab-' + el.dataset.tab).classList.add('active');
    }

    // Auto-load if there's a previous run
    fetch('/api/report').then(r => r.ok ? r.json() : null).then(data => {
      if (data) {
        currentReport = data.report;
        document.getElementById('empty-state').style.display = 'none';
        document.getElementById('dashboard').style.display = 'block';
        renderDashboard(data);
      }
    }).catch(() => {});
  </script>
</body>
</html>
