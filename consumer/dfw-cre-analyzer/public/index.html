<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>DFW CRE Investment Analyzer</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <style>
    :root {
      --bg: #0d1117; --surface: #161b22; --border: #30363d;
      --text: #e6edf3; --muted: #8b949e; --accent: #58a6ff;
      --green: #3fb950; --yellow: #d29922; --orange: #f0883e; --red: #f85149;
      --strong-buy: #3fb950; --buy: #58a6ff; --watch: #d29922; --pass: #8b949e;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); }

    .header { background: var(--surface); border-bottom: 1px solid var(--border); padding: 16px 24px; display: flex; align-items: center; justify-content: space-between; }
    .header h1 { font-size: 20px; font-weight: 700; }
    .header h1 span { color: var(--accent); }
    .header-actions { display: flex; gap: 10px; }
    .btn { padding: 8px 16px; border-radius: 6px; border: 1px solid var(--border); background: var(--surface); color: var(--text); cursor: pointer; font-size: 13px; transition: all 0.2s; }
    .btn:hover { border-color: var(--accent); color: var(--accent); }
    .btn-primary { background: var(--accent); color: #000; border-color: var(--accent); font-weight: 600; }
    .btn-primary:hover { background: #79c0ff; }

    .container { max-width: 1400px; margin: 0 auto; padding: 20px; }

    /* KPI Cards */
    .kpi-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 14px; margin-bottom: 20px; }
    .kpi-card { background: var(--surface); border: 1px solid var(--border); border-radius: 10px; padding: 18px; }
    .kpi-label { font-size: 11px; color: var(--muted); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 6px; }
    .kpi-value { font-size: 28px; font-weight: 700; }
    .kpi-sub { font-size: 12px; color: var(--muted); margin-top: 4px; }

    /* Tabs */
    .tabs { display: flex; gap: 4px; margin-bottom: 16px; border-bottom: 1px solid var(--border); padding-bottom: 0; }
    .tab { padding: 10px 18px; cursor: pointer; font-size: 13px; font-weight: 500; color: var(--muted); border-bottom: 2px solid transparent; transition: all 0.2s; }
    .tab:hover { color: var(--text); }
    .tab.active { color: var(--accent); border-bottom-color: var(--accent); }
    .tab-content { display: none; }
    .tab-content.active { display: block; }

    /* Filters */
    .filters { background: var(--surface); border: 1px solid var(--border); border-radius: 8px; padding: 14px 18px; margin-bottom: 16px; display: flex; gap: 12px; flex-wrap: wrap; align-items: center; }
    .filter-group { display: flex; flex-direction: column; gap: 4px; }
    .filter-group label { font-size: 11px; color: var(--muted); text-transform: uppercase; }
    .filter-group select, .filter-group input { background: var(--bg); border: 1px solid var(--border); color: var(--text); padding: 6px 10px; border-radius: 5px; font-size: 13px; }

    /* Table */
    .table-wrap { overflow-x: auto; }
    table { width: 100%; border-collapse: collapse; font-size: 13px; }
    th { text-align: left; padding: 10px 12px; background: var(--surface); border-bottom: 2px solid var(--border); color: var(--muted); font-size: 11px; text-transform: uppercase; letter-spacing: 0.5px; position: sticky; top: 0; }
    td { padding: 10px 12px; border-bottom: 1px solid var(--border); }
    tr:hover { background: rgba(88,166,255,0.04); }
    tr { cursor: pointer; }

    /* Flag badges */
    .flag { display: inline-block; padding: 3px 10px; border-radius: 12px; font-size: 11px; font-weight: 600; }
    .flag-STRONG_BUY { background: rgba(63,185,80,0.15); color: var(--strong-buy); }
    .flag-BUY { background: rgba(88,166,255,0.15); color: var(--buy); }
    .flag-WATCH { background: rgba(210,153,34,0.15); color: var(--watch); }
    .flag-PASS { background: rgba(139,148,158,0.15); color: var(--pass); }

    .type-badge { display: inline-block; padding: 2px 8px; border-radius: 4px; font-size: 11px; background: rgba(88,166,255,0.1); color: var(--accent); }

    /* Map */
    #map { height: 500px; border-radius: 10px; border: 1px solid var(--border); }

    /* Score bar */
    .score-bar { display: inline-block; height: 6px; border-radius: 3px; vertical-align: middle; }
    .score-num { font-weight: 700; font-size: 14px; margin-right: 6px; }

    /* Modal */
    .modal-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.7); z-index: 1000; justify-content: center; align-items: flex-start; padding: 40px 20px; overflow-y: auto; }
    .modal-overlay.active { display: flex; }
    .modal { background: var(--surface); border: 1px solid var(--border); border-radius: 12px; max-width: 900px; width: 100%; padding: 24px; position: relative; }
    .modal-close { position: absolute; top: 12px; right: 16px; font-size: 24px; cursor: pointer; color: var(--muted); background: none; border: none; }
    .modal-close:hover { color: var(--text); }
    .modal h2 { font-size: 20px; margin-bottom: 4px; }
    .modal-meta { color: var(--muted); font-size: 13px; margin-bottom: 16px; }
    .detail-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 20px; }
    .detail-card { background: var(--bg); border: 1px solid var(--border); border-radius: 8px; padding: 14px; }
    .detail-card h3 { font-size: 13px; color: var(--muted); margin-bottom: 10px; text-transform: uppercase; }
    .detail-row { display: flex; justify-content: space-between; padding: 4px 0; font-size: 13px; }
    .detail-row span:last-child { font-weight: 600; }
    .score-breakdown { display: flex; gap: 12px; margin: 12px 0; }
    .score-pill { flex: 1; background: var(--bg); border: 1px solid var(--border); border-radius: 8px; padding: 12px; text-align: center; }
    .score-pill .label { font-size: 11px; color: var(--muted); margin-bottom: 4px; }
    .score-pill .value { font-size: 22px; font-weight: 700; }
    .comp-table { width: 100%; font-size: 12px; margin-top: 8px; }
    .comp-table th { font-size: 10px; padding: 6px 8px; }
    .comp-table td { padding: 6px 8px; }

    /* Pagination */
    .pagination { display: flex; align-items: center; justify-content: center; gap: 12px; margin-top: 16px; }
    .pagination .btn { padding: 6px 14px; }
    .page-info { color: var(--muted); font-size: 13px; }

    /* Loading */
    .loading { text-align: center; padding: 60px; color: var(--muted); }
    .spinner { display: inline-block; width: 30px; height: 30px; border: 3px solid var(--border); border-top-color: var(--accent); border-radius: 50%; animation: spin 0.8s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
  </style>
</head>
<body>

<div class="header">
  <h1>üè¢ DFW <span>CRE</span> Investment Analyzer</h1>
  <div class="header-actions">
    <button class="btn" id="live-btn" onclick="runLiveIngestion('loopnet')" title="Fetch live CRE data from LoopNet API">üè¢ LoopNet Live</button>
    <button class="btn" id="zillow-btn" onclick="runLiveIngestion('zillow')" title="Fetch live data from Zillow API">üè† Zillow Live</button>
    <button class="btn" onclick="exportCSV()">üì• Export CSV</button>
    <button class="btn btn-primary" onclick="loadData()">üîÑ Refresh</button>
  </div>
</div>

<div class="container">
  <!-- KPI Cards -->
  <div class="kpi-grid">
    <div class="kpi-card"><div class="kpi-label">Total Properties</div><div class="kpi-value" id="kpi-total">‚Äî</div><div class="kpi-sub">DFW Commercial</div></div>
    <div class="kpi-card"><div class="kpi-label">Strong Buy</div><div class="kpi-value" id="kpi-strongbuy" style="color:var(--strong-buy)">‚Äî</div><div class="kpi-sub">Score ‚â•75 + High Confidence</div></div>
    <div class="kpi-card"><div class="kpi-label">Buy</div><div class="kpi-value" id="kpi-buy" style="color:var(--buy)">‚Äî</div><div class="kpi-sub">Score 55‚Äì74</div></div>
    <div class="kpi-card"><div class="kpi-label">Avg Price</div><div class="kpi-value" id="kpi-avgprice">‚Äî</div><div class="kpi-sub">Listing Price</div></div>
    <div class="kpi-card"><div class="kpi-label">Avg $/Sqft</div><div class="kpi-value" id="kpi-avgppsf">‚Äî</div><div class="kpi-sub">All Properties</div></div>
    <div class="kpi-card"><div class="kpi-label">Avg Score</div><div class="kpi-value" id="kpi-avgscore" style="color:var(--yellow)">‚Äî</div><div class="kpi-sub">Underpricing (0‚Äì100)</div></div>
  </div>

  <!-- Tabs -->
  <div class="tabs">
    <div class="tab active" data-tab="deals" onclick="switchTab(this)">üî• Top Deals</div>
    <div class="tab" data-tab="listings" onclick="switchTab(this)">üìã All Listings</div>
    <div class="tab" data-tab="map" onclick="switchTab(this)">üó∫Ô∏è Map</div>
    <div class="tab" data-tab="market" onclick="switchTab(this)">üìä Market</div>
    <div class="tab" data-tab="admin" onclick="switchTab(this)">‚öôÔ∏è Admin</div>
  </div>

  <!-- Top Deals -->
  <div class="tab-content active" id="tab-deals">
    <div class="table-wrap">
      <table>
        <thead><tr>
          <th>#</th><th>Address</th><th>City</th><th>Type</th><th>Price</th><th>$/Sqft</th>
          <th>Zestimate</th><th>Gap</th><th>Score</th><th>Flag</th><th>DOM</th>
        </tr></thead>
        <tbody id="deals-body"></tbody>
      </table>
    </div>
  </div>

  <!-- All Listings -->
  <div class="tab-content" id="tab-listings">
    <div class="filters">
      <div class="filter-group">
        <label>Property Type</label>
        <select id="f-type" onchange="applyFilters()">
          <option value="">All Types</option>
          <option value="MULTI_FAMILY">Multi-Family</option>
          <option value="RETAIL">Retail</option>
          <option value="OFFICE">Office</option>
          <option value="INDUSTRIAL">Industrial</option>
          <option value="MIXED_USE">Mixed Use</option>
          <option value="LAND">Land</option>
        </select>
      </div>
      <div class="filter-group">
        <label>Investment Flag</label>
        <select id="f-flag" onchange="applyFilters()">
          <option value="">All Flags</option>
          <option value="STRONG_BUY">Strong Buy</option>
          <option value="BUY">Buy</option>
          <option value="WATCH">Watch</option>
          <option value="PASS">Pass</option>
        </select>
      </div>
      <div class="filter-group">
        <label>Min Price</label>
        <input type="number" id="f-priceMin" placeholder="0" onchange="applyFilters()">
      </div>
      <div class="filter-group">
        <label>Max Price</label>
        <input type="number" id="f-priceMax" placeholder="Any" onchange="applyFilters()">
      </div>
      <div class="filter-group">
        <label>Min Score</label>
        <input type="number" id="f-scoreMin" placeholder="0" min="0" max="100" onchange="applyFilters()">
      </div>
      <div class="filter-group">
        <label>Sort By</label>
        <select id="f-sort" onchange="applyFilters()">
          <option value="score">Score</option>
          <option value="price">Price</option>
          <option value="pricePerSqft">$/Sqft</option>
          <option value="daysOnMarket">Days on Market</option>
        </select>
      </div>
      <div class="filter-group">
        <label>Order</label>
        <select id="f-order" onchange="applyFilters()">
          <option value="desc">High ‚Üí Low</option>
          <option value="asc">Low ‚Üí High</option>
        </select>
      </div>
    </div>
    <div class="table-wrap">
      <table>
        <thead><tr>
          <th>#</th><th>Address</th><th>City</th><th>ZIP</th><th>Type</th><th>Price</th><th>Sqft</th><th>$/Sqft</th>
          <th>Zestimate</th><th>Rent Est</th><th>Score</th><th>Flag</th><th>Walk</th><th>DOM</th>
        </tr></thead>
        <tbody id="listings-body"></tbody>
      </table>
    </div>
    <div class="pagination">
      <button class="btn" id="prev-btn" onclick="changePage(-1)">‚Üê Previous</button>
      <span class="page-info" id="page-info">Page 1</span>
      <button class="btn" id="next-btn" onclick="changePage(1)">Next ‚Üí</button>
    </div>
  </div>

  <!-- Map -->
  <div class="tab-content" id="tab-map">
    <div id="map"></div>
  </div>

  <!-- Market Summary -->
  <div class="tab-content" id="tab-market">
    <div class="detail-grid">
      <div class="detail-card">
        <h3>Flag Distribution</h3>
        <div id="flag-dist"></div>
      </div>
      <div class="detail-card">
        <h3>Property Types</h3>
        <div id="type-dist"></div>
      </div>
      <div class="detail-card" style="grid-column: 1 / -1">
        <h3>Top ZIP Codes by Score</h3>
        <div id="top-zips"></div>
      </div>
    </div>
  </div>

  <!-- Admin -->
  <div class="tab-content" id="tab-admin">
    <div class="detail-grid">
      <div class="detail-card">
        <h3>API Quota (Today)</h3>
        <div id="quota-today"></div>
      </div>
      <div class="detail-card">
        <h3>Last 7 Days</h3>
        <div id="quota-7days"></div>
      </div>
    </div>
  </div>
</div>

<!-- Property Detail Modal -->
<div class="modal-overlay" id="modal-overlay" onclick="if(event.target===this)closeModal()">
  <div class="modal">
    <button class="modal-close" onclick="closeModal()">‚úï</button>
    <div id="modal-content"><div class="loading"><div class="spinner"></div><p>Loading...</p></div></div>
  </div>
</div>

<script>
  const API = '/api/v1';
  let currentPage = 1;
  let totalPages = 1;
  let map = null;
  let markers = null;

  // ‚îÄ‚îÄ Tab switching ‚îÄ‚îÄ
  function switchTab(el) {
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
    el.classList.add('active');
    document.getElementById('tab-' + el.dataset.tab).classList.add('active');
    if (el.dataset.tab === 'map') initMap();
  }

  // ‚îÄ‚îÄ Load data ‚îÄ‚îÄ
  async function loadData() {
    try {
      const [summary, deals] = await Promise.all([
        fetch(API + '/market/summary').then(r => r.json()),
        fetch(API + '/properties?sortBy=score&sortOrder=desc&pageSize=15&investmentFlag=STRONG_BUY&investmentFlag=BUY').then(r => r.json()),
      ]);
      renderKPIs(summary);
      renderDeals(deals.data);
      renderMarket(summary);
      applyFilters();
      loadAdmin();
    } catch(e) {
      console.error('Load failed:', e);
    }
  }

  function renderKPIs(s) {
    document.getElementById('kpi-total').textContent = s.totalProperties;
    document.getElementById('kpi-strongbuy').textContent = s.flagCounts.STRONG_BUY || 0;
    document.getElementById('kpi-buy').textContent = s.flagCounts.BUY || 0;
    document.getElementById('kpi-avgprice').textContent = '$' + (s.avgListingPrice / 1e6).toFixed(1) + 'M';
    document.getElementById('kpi-avgppsf').textContent = '$' + s.avgPricePerSqft;
    document.getElementById('kpi-avgscore').textContent = s.avgUnderpricingScore;
  }

  function renderDeals(properties) {
    const tbody = document.getElementById('deals-body');
    tbody.innerHTML = properties.map((p, i) => {
      const gap = p.zestimateValue ? Math.round((p.zestimateValue - p.listingPrice) / p.zestimateValue * 100) : 0;
      const gapColor = gap > 15 ? 'var(--green)' : gap > 5 ? 'var(--yellow)' : 'var(--muted)';
      return `<tr onclick="openDetail('${p.id}')">
        <td>${i+1}</td>
        <td><strong>${p.address}</strong></td>
        <td>${p.city}</td>
        <td><span class="type-badge">${p.propertyType.replace('_',' ')}</span></td>
        <td>$${(p.listingPrice/1e6).toFixed(2)}M</td>
        <td>${p.pricePerSqft ? '$'+p.pricePerSqft.toFixed(0) : '‚Äî'}</td>
        <td>${p.zestimateValue ? '$'+(p.zestimateValue/1e6).toFixed(2)+'M' : '‚Äî'}</td>
        <td style="color:${gapColor};font-weight:600">${gap > 0 ? '+'+gap+'%' : gap+'%'}</td>
        <td>${renderScoreInline(p.underpricingScore)}</td>
        <td><span class="flag flag-${p.investmentFlag}">${(p.investmentFlag||'').replace('_',' ')}</span></td>
        <td>${p.daysOnMarket || '‚Äî'}d</td>
      </tr>`;
    }).join('');
  }

  function renderScoreInline(score) {
    if (!score) return '‚Äî';
    const color = score >= 75 ? 'var(--green)' : score >= 55 ? 'var(--accent)' : score >= 35 ? 'var(--yellow)' : 'var(--muted)';
    return `<span class="score-num" style="color:${color}">${score}</span><span class="score-bar" style="width:${score}px;background:${color}"></span>`;
  }

  // ‚îÄ‚îÄ Filtered listings ‚îÄ‚îÄ
  async function applyFilters() {
    const params = new URLSearchParams();
    const type = document.getElementById('f-type').value;
    const flag = document.getElementById('f-flag').value;
    const priceMin = document.getElementById('f-priceMin').value;
    const priceMax = document.getElementById('f-priceMax').value;
    const scoreMin = document.getElementById('f-scoreMin').value;
    const sort = document.getElementById('f-sort').value;
    const order = document.getElementById('f-order').value;

    if (type) params.set('propertyType', type);
    if (flag) params.set('investmentFlag', flag);
    if (priceMin) params.set('priceMin', priceMin);
    if (priceMax) params.set('priceMax', priceMax);
    if (scoreMin) params.set('underpricingMin', scoreMin);
    params.set('sortBy', sort);
    params.set('sortOrder', order);
    params.set('page', currentPage);
    params.set('pageSize', '20');

    const result = await fetch(API + '/properties?' + params).then(r => r.json());
    totalPages = Math.ceil(result.total / result.pageSize);
    document.getElementById('page-info').textContent = `Page ${result.page} of ${totalPages} (${result.total} properties)`;
    document.getElementById('prev-btn').disabled = result.page <= 1;
    document.getElementById('next-btn').disabled = result.page >= totalPages;

    const tbody = document.getElementById('listings-body');
    tbody.innerHTML = result.data.map((p, i) => `
      <tr onclick="openDetail('${p.id}')">
        <td>${(result.page-1)*result.pageSize + i + 1}</td>
        <td><strong>${p.address}</strong></td>
        <td>${p.city}</td>
        <td>${p.zipCode}</td>
        <td><span class="type-badge">${p.propertyType.replace('_',' ')}</span></td>
        <td>$${(p.listingPrice/1e6).toFixed(2)}M</td>
        <td>${p.sqft ? p.sqft.toLocaleString() : '‚Äî'}</td>
        <td>${p.pricePerSqft ? '$'+p.pricePerSqft.toFixed(0) : '‚Äî'}</td>
        <td>${p.zestimateValue ? '$'+(p.zestimateValue/1e6).toFixed(2)+'M' : '‚Äî'}</td>
        <td>${p.rentEstimate ? '$'+p.rentEstimate.toLocaleString()+'/mo' : '‚Äî'}</td>
        <td>${renderScoreInline(p.underpricingScore)}</td>
        <td><span class="flag flag-${p.investmentFlag}">${(p.investmentFlag||'').replace('_',' ')}</span></td>
        <td>${p.walkScore || '‚Äî'}</td>
        <td>${p.daysOnMarket || '‚Äî'}d</td>
      </tr>
    `).join('');
  }

  function changePage(delta) {
    currentPage = Math.max(1, Math.min(totalPages, currentPage + delta));
    applyFilters();
  }

  // ‚îÄ‚îÄ Map ‚îÄ‚îÄ
  function initMap() {
    if (map) { map.invalidateSize(); return; }
    setTimeout(() => {
      map = L.map('map').setView([32.78, -96.80], 10);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '¬© OpenStreetMap'
      }).addTo(map);
      loadMapData();
    }, 100);
  }

  async function loadMapData() {
    const data = await fetch(API + '/properties/map').then(r => r.json());
    if (markers) map.removeLayer(markers);
    markers = L.layerGroup();

    const flagColors = { STRONG_BUY: '#3fb950', BUY: '#58a6ff', WATCH: '#d29922', PASS: '#8b949e' };
    data.features.forEach(f => {
      const p = f.properties;
      const color = flagColors[p.investmentFlag] || '#8b949e';
      const marker = L.circleMarker([f.geometry.coordinates[1], f.geometry.coordinates[0]], {
        radius: 6 + (p.underpricingScore || 0) / 15,
        fillColor: color, color: '#fff', weight: 1, fillOpacity: 0.8,
      });
      marker.bindPopup(`
        <div style="font-family:sans-serif;font-size:13px">
          <strong>${p.address}</strong><br>
          <span style="color:${color};font-weight:600">${p.investmentFlag.replace('_',' ')}</span> ¬∑ Score: ${p.underpricingScore}<br>
          $${(p.listingPrice/1e6).toFixed(2)}M ¬∑ ${p.propertyType.replace('_',' ')}<br>
          <a href="#" onclick="openDetail('${p.id}');return false" style="color:#58a6ff">View Details ‚Üí</a>
        </div>
      `);
      markers.addLayer(marker);
    });
    markers.addTo(map);
  }

  // ‚îÄ‚îÄ Market summary ‚îÄ‚îÄ
  function renderMarket(s) {
    const flagColors = { STRONG_BUY: 'var(--green)', BUY: 'var(--accent)', WATCH: 'var(--yellow)', PASS: 'var(--muted)' };
    document.getElementById('flag-dist').innerHTML = Object.entries(s.flagCounts).map(([k,v]) =>
      `<div class="detail-row"><span><span class="flag flag-${k}" style="margin-right:8px">${k.replace('_',' ')}</span></span><span>${v}</span></div>`
    ).join('');

    document.getElementById('type-dist').innerHTML = Object.entries(s.typeCounts).sort((a,b) => b[1]-a[1]).map(([k,v]) =>
      `<div class="detail-row"><span>${k.replace('_',' ')}</span><span>${v}</span></div>`
    ).join('');

    document.getElementById('top-zips').innerHTML = `<table style="width:100%;font-size:13px">
      <tr style="color:var(--muted);font-size:11px"><th style="text-align:left;padding:6px">ZIP</th><th>Properties</th><th>Avg Score</th></tr>
      ${s.topZips.map(z => `<tr><td style="padding:6px;font-weight:600">${z.zipCode}</td><td style="text-align:center">${z.count}</td><td style="text-align:center">${renderScoreInline(z.avgScore)}</td></tr>`).join('')}
    </table>`;
  }

  // ‚îÄ‚îÄ Admin ‚îÄ‚îÄ
  async function loadAdmin() {
    const q = await fetch(API + '/admin/quota').then(r => r.json());
    document.getElementById('quota-today').innerHTML = `
      <div class="detail-row"><span>Requests Today</span><span style="font-size:24px;font-weight:700">${q.today.total}</span></div>
      <div class="detail-row"><span>Daily Limit</span><span>${q.dailyLimit}</span></div>
      <div class="detail-row"><span>Remaining</span><span style="color:${q.remaining < 10 ? 'var(--red)' : 'var(--green)'}">${q.remaining}</span></div>
      ${Object.entries(q.today.byEndpoint).map(([k,v]) =>
        `<div class="detail-row" style="font-size:12px"><span style="color:var(--muted)">${k}</span><span>${v}</span></div>`
      ).join('')}
    `;
    document.getElementById('quota-7days').innerHTML = q.last7Days.length ?
      q.last7Days.map(d => `<div class="detail-row"><span>${d.date}</span><span>${d.total} req</span></div>`).join('') :
      '<p style="color:var(--muted);padding:12px">No API calls logged yet</p>';
  }

  // ‚îÄ‚îÄ Property Detail Modal ‚îÄ‚îÄ
  async function openDetail(id) {
    document.getElementById('modal-overlay').classList.add('active');
    document.getElementById('modal-content').innerHTML = '<div class="loading"><div class="spinner"></div><p>Loading property...</p></div>';

    const p = await fetch(API + '/properties/' + id).then(r => r.json());
    const gap = p.zestimateValue ? Math.round((p.zestimateValue - p.listingPrice) / p.zestimateValue * 100) : 0;
    const capRate = p.rentEstimate ? ((p.rentEstimate * 12 / p.listingPrice) * 100).toFixed(2) : '‚Äî';

    document.getElementById('modal-content').innerHTML = `
      <h2>${p.address}</h2>
      <div class="modal-meta">${p.city}, ${p.state} ${p.zipCode} ¬∑ <span class="type-badge">${p.propertyType.replace('_',' ')}</span> ¬∑ <span class="flag flag-${p.investmentFlag}">${(p.investmentFlag||'').replace('_',' ')}</span></div>

      <div class="score-breakdown">
        <div class="score-pill"><div class="label">Overall Score</div><div class="value" style="color:${scoreColor(p.underpricingScore)}">${p.underpricingScore || '‚Äî'}</div></div>
        <div class="score-pill"><div class="label">Comp Gap</div><div class="value">${p.compGapScore || '‚Äî'}</div></div>
        <div class="score-pill"><div class="label">Zestimate Gap</div><div class="value">${p.zestimateGapScore || '‚Äî'}</div></div>
        <div class="score-pill"><div class="label">Rent Yield</div><div class="value">${p.rentYieldScore || '‚Äî'}</div></div>
      </div>

      <div class="detail-grid">
        <div class="detail-card">
          <h3>üí∞ Pricing</h3>
          <div class="detail-row"><span>Listing Price</span><span>$${(p.listingPrice/1e6).toFixed(2)}M</span></div>
          <div class="detail-row"><span>Zestimate</span><span>${p.zestimateValue ? '$'+(p.zestimateValue/1e6).toFixed(2)+'M' : '‚Äî'}</span></div>
          <div class="detail-row"><span>Zestimate Range</span><span>${p.zestimateLow ? '$'+(p.zestimateLow/1e6).toFixed(2)+'M ‚Äì $'+(p.zestimateHigh/1e6).toFixed(2)+'M' : '‚Äî'}</span></div>
          <div class="detail-row"><span>Gap to Zestimate</span><span style="color:${gap>0?'var(--green)':'var(--red)'}"> ${gap>0?'+':''}${gap}%</span></div>
          <div class="detail-row"><span>Price / Sqft</span><span>${p.pricePerSqft ? '$'+p.pricePerSqft.toFixed(0) : '‚Äî'}</span></div>
          <div class="detail-row"><span>Comp Avg $/Sqft</span><span>${p.compAvgPpsf ? '$'+p.compAvgPpsf.toFixed(0) : '‚Äî'}</span></div>
          <div class="detail-row"><span>Rent Estimate</span><span>${p.rentEstimate ? '$'+p.rentEstimate.toLocaleString()+'/mo' : '‚Äî'}</span></div>
          <div class="detail-row"><span>Cap Rate</span><span>${capRate}%</span></div>
        </div>
        <div class="detail-card">
          <h3>üèóÔ∏è Property Details</h3>
          <div class="detail-row"><span>Sqft</span><span>${p.sqft ? p.sqft.toLocaleString() : '‚Äî'}</span></div>
          <div class="detail-row"><span>Year Built</span><span>${p.yearBuilt || '‚Äî'}</span></div>
          <div class="detail-row"><span>Lot Size</span><span>${p.lotSize ? p.lotSize.toLocaleString()+' sqft' : '‚Äî'}</span></div>
          <div class="detail-row"><span>Walk Score</span><span>${p.walkScore || '‚Äî'}</span></div>
          <div class="detail-row"><span>Transit Score</span><span>${p.transitScore || '‚Äî'}</span></div>
          <div class="detail-row"><span>Bike Score</span><span>${p.bikeScore || '‚Äî'}</span></div>
          <div class="detail-row"><span>Days on Market</span><span>${p.daysOnMarket || '‚Äî'}</span></div>
          <div class="detail-row"><span>Listed</span><span>${p.listedDate || '‚Äî'}</span></div>
        </div>
      </div>

      ${p.comps && p.comps.length > 0 ? `
      <div class="detail-card" style="margin-bottom:16px">
        <h3>üìä Comparable Sales (${p.comps.length})</h3>
        <table class="comp-table">
          <thead><tr><th>Address</th><th>Sold Price</th><th>Sqft</th><th>$/Sqft</th><th>Distance</th><th>Date</th></tr></thead>
          <tbody>${p.comps.map(c => `<tr>
            <td>${c.address}</td>
            <td>$${(c.soldPrice/1e6).toFixed(2)}M</td>
            <td>${c.sqft ? c.sqft.toLocaleString() : '‚Äî'}</td>
            <td>${c.pricePerSqft ? '$'+c.pricePerSqft.toFixed(0) : '‚Äî'}</td>
            <td>${c.distanceMiles ? c.distanceMiles+'mi' : '‚Äî'}</td>
            <td>${c.soldDate}</td>
          </tr>`).join('')}</tbody>
        </table>
      </div>` : ''}

      ${p.priceHistory && p.priceHistory.length > 0 ? `
      <div class="detail-card">
        <h3>üìà Price History</h3>
        ${p.priceHistory.map(h => `
          <div class="detail-row">
            <span>${h.date} ¬∑ <span style="color:var(--accent)">${h.event.replace('_',' ')}</span></span>
            <span>$${(h.price/1e6).toFixed(2)}M</span>
          </div>
        `).join('')}
      </div>` : ''}
    `;
  }

  function scoreColor(s) {
    if (!s) return 'var(--muted)';
    if (s >= 75) return 'var(--green)';
    if (s >= 55) return 'var(--accent)';
    if (s >= 35) return 'var(--yellow)';
    return 'var(--muted)';
  }

  function closeModal() {
    document.getElementById('modal-overlay').classList.remove('active');
  }

  function exportCSV() {
    window.open(API + '/properties/export?sortBy=score&sortOrder=desc', '_blank');
  }

  // Keyboard: Escape closes modal
  document.addEventListener('keydown', e => { if (e.key === 'Escape') closeModal(); });

  // ‚îÄ‚îÄ Live Ingestion ‚îÄ‚îÄ
  async function runLiveIngestion(provider) {
    const btn = provider === 'zillow' ? document.getElementById('zillow-btn') : document.getElementById('live-btn');
    const origText = btn.textContent;
    btn.textContent = '‚è≥ Ingesting...';
    btn.disabled = true;
    btn.style.opacity = '0.6';

    try {
      const res = await fetch(API + '/ingest', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ provider: provider || 'loopnet', maxZips: 5, enrichTop: 15 }),
      });
      const data = await res.json();
      if (data.error) {
        alert('‚ö†Ô∏è ' + data.error);
      } else {
        alert(`‚úÖ ${(data.provider || provider).toUpperCase()} ingestion complete!\n\nüì• Ingested: ${data.ingested} properties\nüî¨ Enriched: ${data.enriched}\nüìä Scored: ${data.scored}`);
        loadData();
      }
    } catch (err) {
      alert('‚ùå Ingestion failed: ' + err.message);
    } finally {
      btn.textContent = origText;
      btn.disabled = false;
      btn.style.opacity = '1';
    }
  }

  // Boot
  loadData();
</script>
</body>
</html>
